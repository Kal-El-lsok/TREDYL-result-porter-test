<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Nursery Admin - TREDYL SCHOOLS</title>
    
    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
    
    <style>
        /* KEEP YOUR EXISTING STYLES - DON'T CHANGE */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #0f172a; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .admin-container { background: white; border-radius: 15px; width: 100%; max-width: 900px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .admin-header { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 25px; text-align: center; }
        .admin-content { padding: 30px; }
        .password-screen { text-align: center; padding: 40px 20px; }
        .password-input { width: 300px; padding: 15px; margin: 20px auto; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; display: block; }
        .password-btn { background: #10b981; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .password-error { color: #ef4444; margin-top: 10px; display: none; }
        .management-section { display: none; }
        .stats-box { background: #f8fafc; border-radius: 10px; padding: 20px; margin-bottom: 25px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .stat-item { text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 700; color: #d97706; }
        .stat-label { color: #64748b; font-size: 0.9rem; }
        .students-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .student-card { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; }
        .student-card.granted { border-color: #10b981; background: #f0fdf4; }
        .student-card.denied { border-color: #fca5a5; background: #fef2f2; }
        .student-name { font-size: 1.2rem; font-weight: 600; color: #1e293b; margin-bottom: 5px; }
        .student-details { color: #64748b; font-size: 0.9rem; margin-bottom: 15px; }
        .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-top: 10px; }
        .status-granted { background: #d1fae5; color: #065f46; }
        .status-denied { background: #fee2e2; color: #dc2626; }
        .action-buttons { margin-top: 15px; display: flex; gap: 10px; }
        .action-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .grant-btn { background: #10b981; color: white; }
        .revoke-btn { background: #ef4444; color: white; }
        .logout-btn { background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; float: right; margin-top: 20px; }
        .search-box { margin-bottom: 20px; }
        .search-input { width: 100%; padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; }
        .roll-display { font-family: 'Courier New', monospace; font-weight: bold; color: #1e293b; }
        
        /* ADD THESE NEW STYLES */
        .status-indicator {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-online {
            background: #10b981;
            color: white;
        }
        .status-offline {
            background: #ef4444;
            color: white;
        }
        .mode-indicator {
            padding: 8px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .mode-cloud {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }
        .mode-local {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>PRE-NURSERY ADMIN PORTAL</h1>
            <p>Student Result Access Management</p>
        </div>
        
        <!-- Password Screen -->
        <div class="admin-content" id="passwordScreen">
            <div class="password-screen">
                <h2>ADMIN AUTHENTICATION</h2>
                <p>Enter admin password to continue</p>
                
                <input type="password" id="adminPassword" class="password-input" 
                       placeholder="Enter admin password" autofocus>
                
                <button class="password-btn" id="loginButton">
                    ACCESS ADMIN PORTAL
                </button>
                
                <div class="password-error" id="passwordError">
                    Incorrect password
                </div>
            </div>
        </div>
        
        <!-- Management Section -->
        <div class="admin-content management-section" id="managementSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2>PRE-NURSERY STUDENTS 
                    <span id="connectionStatus" class="status-indicator status-offline">OFFLINE</span>
                </h2>
                <button class="logout-btn" id="logoutButton">
                    Logout
                </button>
            </div>
            
            <!-- Mode Indicator -->
            <div id="modeIndicator" class="mode-indicator mode-local">
                <i class="fas fa-exclamation-triangle"></i> LOCAL MODE: Changes won't sync with phones
            </div>
            
            <!-- Statistics -->
            <div class="stats-box">
                <div class="stat-item">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="accessGranted">0</div>
                    <div class="stat-label">Access Granted</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="accessDenied">0</div>
                    <div class="stat-label">Access Denied</div>
                </div>
            </div>
            
            <!-- Search -->
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" 
                       placeholder="Search students by name or roll number...">
            </div>
            
            <!-- Students Grid -->
            <div class="students-grid" id="studentsGrid">
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px;"></i>
                    <p>Loading students...</p>
                </div>
            </div>
            
            <!-- Instructions -->
            <div style="margin-top: 30px; padding: 15px; background: #fef3c7; border-radius: 8px; color: #92400e;">
                <h4>ADMIN INSTRUCTIONS:</h4>
                <p>1. Click GRANT ACCESS when student completes school fees</p>
                <p>2. Click REVOKE ACCESS to remove access if needed</p>
                <p>3. <strong id="syncStatus">LOCAL MODE:</strong> Changes won't sync with student phones</p>
                <p>4. To enable phone sync, check Firebase configuration</p>
            </div>
            
            <!-- Firebase Help -->
            <div id="firebaseHelp" style="margin-top: 20px; padding: 15px; background: #dbeafe; border-radius: 8px; color: #1e40af; display: none;">
                <h4><i class="fas fa-cloud"></i> FIREBASE SETUP NEEDED</h4>
                <p>To sync with student phones:</p>
                <ol>
                    <li>Get Firebase config from <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></li>
                    <li>Replace the firebaseConfig object in this file (lines 180-187)</li>
                    <li>Refresh this page</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // 1. FIREBASE CONFIGURATION
        // ============================================
        // ‚ö†Ô∏è REPLACE WITH YOUR ACTUAL FIREBASE CONFIG ‚ö†Ô∏è
        const firebaseConfig = {
            apiKey: "AIzaSyBbswCKXHCr_d_CKY3Ad2WQyflvg7bJV94", // ‚Üê MUST REPLACE WITH YOURS
            authDomain: "tredyl-schools.firebaseapp.com",
            databaseURL: "https://tredyl-schools-default-rtdb.firebaseio.com",
            projectId: "tredyl-schools",
            storageBucket: "tredyl-schools.firebasestorage.app",
            messagingSenderId: "810112149886,
            appId: "1:810112149886:web:0f915a9c6e7f2cc1cdab2f"
        };

        // ============================================
        // 2. GLOBAL VARIABLES
        // ============================================
        let database = null;
        let students = [];
        let isFirebaseConnected = false;
        let usingExampleConfig = true;

        // ============================================
        // 3. INITIALIZE FIREBASE
        // ============================================
        function initializeFirebase() {
            console.log("üîß Initializing Firebase...");
            
            // Check if config is example or real
            usingExampleConfig = firebaseConfig.apiKey.includes("EXAMPLE");
            
            if (usingExampleConfig) {
                console.log("‚ö†Ô∏è Using EXAMPLE Firebase config - Will use LOCAL mode");
                updateStatus("LOCAL MODE", false);
                document.getElementById('firebaseHelp').style.display = 'block';
                return false;
            }
            
            try {
                // Check if Firebase scripts loaded
                if (typeof firebase === 'undefined') {
                    console.error("‚ùå Firebase scripts not loaded");
                    updateStatus("FIREBASE ERROR", false);
                    return false;
                }
                
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                // Test connection
                database.ref('.info/connected').on('value', (snap) => {
                    isFirebaseConnected = snap.val() === true;
                    updateStatus(isFirebaseConnected ? "CONNECTED" : "OFFLINE", isFirebaseConnected);
                });
                
                console.log("‚úÖ Firebase initialized");
                return true;
                
            } catch (error) {
                console.error("‚ùå Firebase initialization failed:", error);
                updateStatus("FIREBASE ERROR", false);
                return false;
            }
        }

        // ============================================
        // 4. LOAD STUDENTS (WITH FALLBACK)
        // ============================================
        async function loadStudents() {
            console.log("üì• Loading students...");
            
            // Default student data
            const defaultStudents = [
                { id: 1, firstName: "Jacinta", lastName: "John", fullName: "Jacinta John", rollNumber: "20203425", class: "Pre-Nursery", feesPaid: false, access: false, pdfName: "20203425.pdf" },
                { id: 2, firstName: "Gabriella", lastName: "Uba", fullName: "Gabriella Uba", rollNumber: "20933225", class: "Pre-Nursery", feesPaid: false, access: false, pdfName: "20933225.pdf" },
                { id: 3, firstName: "Williams", lastName: "Julius", fullName: "Williams Julius", rollNumber: "20458325", class: "Pre-Nursery", feesPaid: false, access: false, pdfName: "20458325.pdf" },
                { id: 4, firstName: "Nanpyal", lastName: "Luke", fullName: "Nanpyal Luke", rollNumber: "20148325", class: "Pre-Nursery", feesPaid: false, access: false, pdfName: "20148325.pdf" },
                { id: 5, firstName: "King David", lastName: "Francis", fullName: "King David Francis", rollNumber: "20670425", class: "Pre-Nursery", feesPaid: false, access: false, pdfName: "20670425.pdf" },
                { id: 6, firstName: "Enoch", lastName: "Louis", fullName: "Enoch Louis", rollNumber: "20182925", class: "Pre-Nursery", feesPaid: false, access: false, pdfName: "20182925.pdf" }
            ];
            
            try {
                if (database && isFirebaseConnected && !usingExampleConfig) {
                    // Try to load from Firebase
                    console.log("üåê Loading from Firebase...");
                    const snapshot = await database.ref('students/preNursery').once('value');
                    const firebaseData = snapshot.val();
                    
                    if (firebaseData && Array.isArray(firebaseData) && firebaseData.length > 0) {
                        students = firebaseData;
                        console.log("‚úÖ Loaded from Firebase:", students.length, "students");
                        updateStatus("CLOUD SYNC ACTIVE", true);
                        document.getElementById('modeIndicator').className = 'mode-indicator mode-cloud';
                        document.getElementById('modeIndicator').innerHTML = '<i class="fas fa-cloud"></i> CLOUD MODE: Changes sync with phones';
                        document.getElementById('syncStatus').innerHTML = '<span style="color:#10b981;">CLOUD SYNC:</span> Changes WILL sync with phones';
                    } else {
                        // No data in Firebase, save defaults
                        students = defaultStudents;
                        await database.ref('students/preNursery').set(students);
                        console.log("üíæ Saved default students to Firebase");
                    }
                } else {
                    // Use local data
                    console.log("üíª Using LOCAL data");
                    students = defaultStudents;
                    updateStatus("LOCAL MODE", false);
                    document.getElementById('modeIndicator').className = 'mode-indicator mode-local';
                    document.getElementById('modeIndicator').innerHTML = '<i class="fas fa-exclamation-triangle"></i> LOCAL MODE: Changes won\'t sync with phones';
                    document.getElementById('syncStatus').innerHTML = '<span style="color:#ef4444;">LOCAL MODE:</span> Changes WON\'T sync with phones';
                }
            } catch (error) {
                // Fallback to local data
                console.error("‚ùå Load error, using local data:", error);
                students = defaultStudents;
                updateStatus("LOCAL (ERROR)", false);
            }
            
            // Display students
            displayStudents();
        }

        // ============================================
        // 5. DISPLAY STUDENTS
        // ============================================
        function displayStudents() {
            const grid = document.getElementById('studentsGrid');
            
            if (students.length === 0) {
                grid.innerHTML = '<div style="text-align:center; padding:40px; color:#64748b;">No students found</div>';
                return;
            }
            
            let html = '';
            let grantedCount = 0;
            let deniedCount = 0;
            
            // Sort by name
            const sorted = [...students].sort((a, b) => a.fullName.localeCompare(b.fullName));
            
            sorted.forEach(student => {
                if (student.access) grantedCount++;
                else deniedCount++;
                
                html += `
                <div class="student-card ${student.access ? 'granted' : 'denied'}">
                    <div class="student-name">${student.fullName}</div>
                    <div class="student-details">
                        <div><strong>Roll Number:</strong> <span class="roll-display">${student.rollNumber}</span></div>
                        <div><strong>Class:</strong> ${student.class}</div>
                        <div><strong>PDF File:</strong> <code>${student.pdfName}</code></div>
                        <div><strong>Fees:</strong> ${student.feesPaid ? '<span style="color:#10b981;">PAID ‚úì</span>' : '<span style="color:#ef4444;">PENDING ‚úó</span>'}</div>
                    </div>
                    
                    <div class="status-badge ${student.access ? 'status-granted' : 'status-denied'}">
                        ${student.access ? 'ACCESS GRANTED' : 'ACCESS DENIED'}
                    </div>
                    
                    <div class="action-buttons">
                        ${!student.access ? 
                            `<button class="action-btn grant-btn" onclick="grantAccess(${student.id})">
                                Grant Access
                            </button>` : 
                            `<button class="action-btn revoke-btn" onclick="revokeAccess(${student.id})">
                                Revoke Access
                            </button>`}
                    </div>
                </div>
                `;
            });
            
            grid.innerHTML = html;
            
            // Update stats
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('accessGranted').textContent = grantedCount;
            document.getElementById('accessDenied').textContent = deniedCount;
            
            console.log(`üìä Displayed ${students.length} students`);
        }

        // ============================================
        // 6. GRANT ACCESS
        // ============================================
        async function grantAccess(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) {
                alert("Student not found!");
                return;
            }
            
            student.access = true;
            student.feesPaid = true;
            
            // Save to Firebase if connected
            if (database && isFirebaseConnected && !usingExampleConfig) {
                try {
                    await database.ref('students/preNursery').set(students);
                    alert(`‚úÖ Access GRANTED to ${student.fullName}\n\nüåê Saved to CLOUD - Students on phones can now see results!`);
                } catch (error) {
                    alert(`‚úÖ Access granted to ${student.fullName}\n\n‚ùå CLOUD save failed: ${error.message}`);
                }
            } else {
                alert(`‚úÖ Access GRANTED to ${student.fullName}\n\n‚ö†Ô∏è LOCAL MODE - Changes NOT saved to cloud\nStudents on phones WON'T see changes.`);
            }
            
            displayStudents();
        }

        // ============================================
        // 7. REVOKE ACCESS
        // ============================================
        async function revokeAccess(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) {
                alert("Student not found!");
                return;
            }
            
            student.access = false;
            student.feesPaid = false;
            
            // Save to Firebase if connected
            if (database && isFirebaseConnected && !usingExampleConfig) {
                try {
                    await database.ref('students/preNursery').set(students);
                    alert(`‚ö†Ô∏è Access REVOKED from ${student.fullName}\n\nüåê Saved to CLOUD`);
                } catch (error) {
                    alert(`‚ö†Ô∏è Access revoked from ${student.fullName}\n\n‚ùå CLOUD save failed`);
                }
            } else {
                alert(`‚ö†Ô∏è Access REVOKED from ${student.fullName}\n\n‚ö†Ô∏è LOCAL MODE - Not saved to cloud`);
            }
            
            displayStudents();
        }

        // ============================================
        // 8. UPDATE STATUS DISPLAY
        // ============================================
        function updateStatus(status, isOnline) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = status;
            statusEl.className = `status-indicator ${isOnline ? 'status-online' : 'status-offline'}`;
        }

        // ============================================
        // 9. CHECK PASSWORD
        // ============================================
        function checkPassword() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === 'KALELTHELASTSONOFKRYPTON') {
                // Show admin panel
                document.getElementById('passwordScreen').style.display = 'none';
                document.getElementById('managementSection').style.display = 'block';
                
                // Initialize Firebase
                initializeFirebase();
                
                // Load students
                loadStudents();
                
                // Setup search
                document.getElementById('searchInput').addEventListener('input', function() {
                    const term = this.value.toLowerCase();
                    const filtered = students.filter(s => 
                        s.fullName.toLowerCase().includes(term) || 
                        s.rollNumber.includes(term)
                    );
                    
                    if (term === '') {
                        displayStudents();
                    } else {
                        // Temporarily display filtered results
                        const tempStudents = students;
                        students = filtered;
                        displayStudents();
                        students = tempStudents;
                    }
                });
                
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('adminPassword').value = '';
            }
        }

        // ============================================
        // 10. LOGOUT
        // ============================================
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                document.getElementById('passwordScreen').style.display = 'block';
                document.getElementById('managementSection').style.display = 'none';
                document.getElementById('passwordError').style.display = 'none';
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        // ============================================
        // 11. CHECK ADMIN URL
        // ============================================
        function checkAdminURL() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') !== '1') {
                window.location.href = 'select class.html';
            }
        }

        // ============================================
        // 12. PAGE INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üöÄ Admin page loaded");
            
            // Check URL
            checkAdminURL();
            
            // Setup login button
            document.getElementById('loginButton').addEventListener('click', checkPassword);
            
            // Setup logout button
            document.getElementById('logoutButton').addEventListener('click', logout);
            
            // Enter key for password
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkPassword();
            });
            
            // Focus on password
            document.getElementById('adminPassword').focus();
            
            console.log("‚úÖ Ready. Password: KALELTHELASTSONOFKRYPTON");
        });

        // ============================================
        // 13. DEBUG HELPER
        // ============================================
        // Add debug button
        setTimeout(() => {
            const debugBtn = document.createElement('button');
            debugBtn.innerHTML = 'üõ†Ô∏è DEBUG';
            debugBtn.style.position = 'fixed';
            debugBtn.style.top = '10px';
            debugBtn.style.right = '10px';
            debugBtn.style.padding = '8px 12px';
            debugBtn.style.background = '#ef4444';
            debugBtn.style.color = 'white';
            debugBtn.style.border = 'none';
            debugBtn.style.borderRadius = '6px';
            debugBtn.style.cursor = 'pointer';
            debugBtn.style.zIndex = '9999';
            
            debugBtn.onclick = function() {
                console.log("=== DEBUG INFO ===");
                console.log("Firebase config valid:", !usingExampleConfig);
                console.log("Firebase connected:", isFirebaseConnected);
                console.log("Database:", database);
                console.log("Students loaded:", students.length);
                console.log("Firebase config:", firebaseConfig);
                alert(`Debug info logged to console (F12)\n\nFirebase: ${isFirebaseConnected ? '‚úÖ Connected' : '‚ùå Not connected'}\nMode: ${usingExampleConfig ? 'LOCAL' : 'CLOUD'}`);
            };
            
            document.body.appendChild(debugBtn);
        }, 1000);
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>